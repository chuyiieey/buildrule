name: CI

on:
  # 主要针对test标签和PR
  push:
    tags: ['*test*']  # 当推送包含test的标签时触发
  pull_request:  # 保留PR触发，用于日常开发

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # 多平台：Linux、Windows、macOS
        os: [ubuntu-latest, windows-latest, macos-latest]
        # 多Python版本
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run type check (mypy)
        run: mypy src/buildrule/

      - name: Run tests (pytest)
        run: pytest tests/ --cov=src/buildrule --cov-report=term

  # 删除test标签的作业，无论测试是否通过都会执行
  cleanup-test-tag:
    needs: [test]  # 等待测试作业完成
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, 'test')
    steps:
      - name: Delete test tag
        run: |
          # 获取标签名
          TEST_TAG="${GITHUB_REF#refs/tags/}"
          # 使用GitHub API删除远程标签
          curl -X DELETE \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$TEST_TAG"
