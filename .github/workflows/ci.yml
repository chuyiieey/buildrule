name: CI

on:
  # 主要针对test标签和PR
  push:
    tags: ['*test*']  # 当推送包含test的标签时触发
  pull_request:  # 保留PR触发，用于日常开发

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # 多平台：Linux、Windows、macOS
        os: [ubuntu-latest, windows-latest, macos-latest]
        # 多Python版本
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run type check (mypy)
        run: mypy src/buildrule/

      - name: Run tests (pytest)
        run: pytest tests/ --cov=src/buildrule --cov-report=term

  # 构建和发布作业，在测试成功后运行
  build-and-publish:
    needs: [test]  # 等待测试作业完成
    runs-on: ubuntu-latest
    # 只有当推送test标签且测试成功时才运行
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, 'test')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build --wheel --sdist

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          twine check dist/*
          twine upload --skip-existing dist/*

      - name: Get version from pyproject.toml
        id: get_version
        run: |
          # 从pyproject.toml中提取版本号
          VERSION=$(grep 'version =' pyproject.toml | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # 删除test标签的作业，无论测试和发布是否通过都会执行
  cleanup-test-tag:
    needs: [test, build-and-publish]  # 等待测试和发布作业完成
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, 'test')
    steps:
      - name: Delete test tag
        run: |
          # 获取标签名
          TEST_TAG="${GITHUB_REF#refs/tags/}"
          # 使用GitHub API删除远程标签
          curl -X DELETE \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/git/refs/tags/${TEST_TAG}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
